<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2601 æ—¥æœ¬ä¹‹æ—… ğŸ‡¯ğŸ‡µ | Japan Trip 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+TC:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #fdfdfe;
            --glass: rgba(255, 255, 255, 0.72);
            --glass-border: rgba(255, 255, 255, 0.5);
            --ios-blur: blur(20px) saturate(180%);
        }

        body {
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(147, 51, 234, 0.05) 0px, transparent 50%);
            min-height: 100vh;
            padding-bottom: 6rem;
            padding-top: 90px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow:
                0 4px 24px -1px rgba(0, 0, 0, 0.04),
                inset 0 0 0 1px rgba(255, 255, 255, 0.4);
        }

        /* Notion-inspired Card Style */
        .activity-card {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            /* Prevent accidental selection during long press/drag */
            user-select: none;
            -webkit-user-select: none;
        }

        .activity-card.editing,
        .activity-card [contenteditable="true"] {
            user-select: text;
            -webkit-user-select: text;
        }

        .card-cover {
            width: 100%;
            height: 140px;
            background-size: cover;
            background-position: center;
            background-color: #f1f5f9;
            position: relative;
        }

        .card-body {
            padding: 1.25rem;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card-icon-floater {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-top: -34px;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid white;
        }

        .activity-card.cat-ç§»å‹• {
            border-left: 8px solid #3b82f6;
        }

        .activity-card.cat-æ™¯é» {
            border-left: 8px solid #10b981;
        }

        .activity-card.cat-åƒå– {
            border-left: 8px solid #f59e0b;
        }

        .activity-card.cat-ä½å®¿ {
            border-left: 8px solid #8b5cf6;
        }

        .activity-card.cat-è³¼ç‰© {
            border-left: 8px solid #ec4899;
        }

        .activity-card.cat-ä½œæ¥­ {
            border-left: 8px solid #64748b;
        }

        /* Category Header Accent */
        .card-cover.cat-accent {
            height: 60px;
            opacity: 0.15;
        }

        .cat-ç§»å‹• .card-cover.cat-accent {
            background-color: #3b82f6;
        }

        .cat-æ™¯é» .card-cover.cat-accent {
            background-color: #10b981;
        }

        .cat-åƒå– .card-cover.cat-accent {
            background-color: #f59e0b;
        }

        .cat-ä½å®¿ .card-cover.cat-accent {
            background-color: #8b5cf6;
        }

        .cat-è³¼ç‰© .card-cover.cat-accent {
            background-color: #ec4899;
        }

        .cat-ä½œæ¥­ .card-cover.cat-accent {
            background-color: #64748b;
        }

        .cat-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .cat-ç§»å‹• .cat-badge {
            background: #3b82f6;
            color: white;
        }

        .cat-æ™¯é» .cat-badge {
            background: #10b981;
            color: white;
        }

        .cat-åƒå– .cat-badge {
            background: #f59e0b;
            color: white;
        }

        .cat-ä½å®¿ .cat-badge {
            background: #8b5cf6;
            color: white;
        }

        .cat-è³¼ç‰© .cat-badge {
            background: #ec4899;
            color: white;
        }

        .cat-ä½œæ¥­ .cat-badge {
            background: #64748b;
            color: white;
        }

        /* Gray-400 */

        /* Gray-200 */

        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .cat-ç§»å‹• .icon-box {
            background: #eff6ff;
            color: #3b82f6;
        }

        /* Blue */
        .cat-æ™¯é» .icon-box {
            background: #ecfdf5;
            color: #10b981;
        }

        /* Emerald */
        .cat-åƒå– .icon-box {
            background: #fffbeb;
            color: #f59e0b;
        }

        /* Amber */
        .cat-ä½å®¿ .icon-box {
            background: #f5f3ff;
            color: #8b5cf6;
        }

        /* Violet */
        .cat-è³¼ç‰© .icon-box {
            background: #fdf2f8;
            color: #ec4899;
        }

        /* Pink */
        .cat-ä½œæ¥­ .icon-box {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Gray */

        /* Google Maps Button */
        .map-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 9999px;
            color: #475569;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
            text-decoration: none;
            margin-top: 12px;
        }

        .map-btn:hover {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
            transform: translateY(-1px);
        }

        .card-detail {
            display: block;
            margin-top: 10px;
            padding-top: 0;
            /* Remove padding as it's cleaner without divider sometimes */
            border-top: none;
            /* Cleaner look */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-btn {
            color: #94a3b8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-btn.active {
            color: var(--primary);
            transform: translateY(-4px) scale(1.1);
            filter: drop-shadow(0 4px 8px rgba(37, 99, 235, 0.2));
        }

        .day-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-btn.active {
            background-color: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .strikethrough {
            text-decoration: line-through;
            opacity: 0.5;
            color: #94a3b8;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Smart Header & Editable Styles */
        header {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.header-hidden header {
            transform: translateY(-100%);
        }

        /* Day Selector Smart Positioning */
        #day-selector {
            position: sticky;
            top: 85px;
            /* Default below header */
            z-index: 30;
            transition: top 0.4s cubic-bezier(0.16, 1, 0.3, 1), background 0.3s;
            padding-top: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid transparent;
            cursor: grab;
            /* Drag cursor */
            user-select: none;
            /* Prevent text selection */
        }

        #day-selector.active {
            cursor: grabbing;
            cursor: -webkit-grabbing;
        }

        /* Sticky Header Visibility */
        #day-selector {
            background: transparent;
            border-bottom: 0.5px solid transparent;
            box-shadow: none;
            transition: all 0.3s ease;
        }

        /* When header is hidden, move to absolute top for 'flush' feel */
        body.header-hidden #day-selector {
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border-radius: 0;
            margin-left: -1rem;
            margin-right: -1rem;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
            z-index: 900;
            /* Below main header but above cards */
        }

        /* Editing Mode - Premium Style */
        [contenteditable]:focus {
            outline: none;
        }

        .activity-card.editing {
            background: #ffffff;
            box-shadow: 0 0 0 2px #3b82f6, 0 12px 24px -6px rgba(59, 130, 246, 0.25);
            transform: translateY(-2px);
            z-index: 20;
        }

        /* Input Fields */
        .editable-field[contenteditable="true"] {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 2px 6px;
            margin: 0 -6px;
            /* Touch area expansion */
            border: 1px solid transparent;
        }

        .editable-field[contenteditable="true"]:hover {
            background: #f1f5f9;
        }

        .editable-field[contenteditable="true"]:focus {
            background: #fff;
            box-shadow: 0 0 0 2px #bfdbfe;
            border-color: #3b82f6;
            color: #1e293b;
        }

        /* Detail Modal Editing Cues */
        #detail-modal [contenteditable="true"] {
            padding: 4px 8px;
            margin: 0 -8px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        #detail-modal [contenteditable="true"]:hover {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        #detail-modal [contenteditable="true"]:focus {
            background: #fff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .editing-label {
            display: none;
            font-size: 10px;
            color: #3b82f6;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        #detail-modal [contenteditable="true"]:focus+.editing-label,
        #detail-modal [contenteditable="true"]:hover+.editing-label {
            display: block;
        }

        @keyframes bounce-gentle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        /* Action Buttons - Always Visible */
        .card-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 10px;
            z-index: 50;
            pointer-events: auto;
            transition: opacity 0.2s;
        }

        .activity-card.editing .card-actions {
            opacity: 0;
            pointer-events: none;
        }

        /* Drag Handle */
        .activity-card.dragging {
            opacity: 0.5;
            z-index: 1000 !important;
            background: #f8fafc;
            border: 2px dashed #3b82f6;
            transform: scale(1.05);
            /* Noticeable lift */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        /* Press feedback animation */
        @keyframes card-press {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(0.96);
            }
        }

        .activity-card.pressing {
            animation: card-press 0.8s ease-in-out forwards;
            background: #f1f5f9;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            /* Add subtle shadow */
        }

        .edit-btn {
            background: #f1f5f9;
            color: #64748b;
        }

        .edit-btn:hover {
            background: #dbeafe;
            color: #3b82f6;
        }

        .delete-btn-static {
            background: #fef2f2;
            color: #ef4444;
        }

        .delete-btn-static:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Editing State for Card */
        /* .activity-card.editing {
            box-shadow: 0 0 0 2px #3b82f6;
            background: #eff6ff;
        } */

        .activity-card.editing .card-actions {
            display: none;
        }

        /* Hide edit/del buttons */

        .done-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 16px;
            background: #3b82f6;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            cursor: pointer;
            z-index: 100;
        }

        .done-btn:hover {
            background: #2563eb;
        }

        .activity-card.editing .done-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-header-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: -38px;
            z-index: 20;
            position: relative;
        }

        .card-header-group.no-cover {
            margin-top: 0;
            margin-bottom: 8px;
        }

        /* Animation for clickable elements in edit mode */
        .hover-pulse {
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        /* Floating Add Button */
        #fab-add {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            cursor: pointer;
        }

        #fab-add:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 32px rgba(37, 99, 235, 0.5);
        }

        #fab-add:active {
            transform: scale(0.95);
        }

        .tab-content:not(.active)~#fab-add,
        #todo.active~#fab-add {
            display: none;
        }

        /* Packing List Styles */
        .packing-category {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .packing-item {
            transition: all 0.2s;
        }

        .packing-item.checked {
            background: #f8fafc;
        }

        .packing-item.checked span {
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* Only show FAB when Itinerary tab is active and modal is CLOSED */
        body:has(#itinerary.active) #fab-add {
            display: flex;
        }

        body.modal-open #fab-add {
            display: none !important;
        }

        body:has(#detail-modal.show) #fab-add {
            display: none !important;
        }

        /* Fallback for browsers that don't support :has */
        .fab-hidden {
            display: none !important;
        }

        #custom-modal {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #custom-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        #custom-modal .modal-card {
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #custom-modal.show .modal-card {
            transform: scale(1);
        }

        /* Cloud Sync UI Styles */
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
            display: inline-block;
            margin-right: 4px;
        }

        .sync-indicator.online {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
        }

        .sync-indicator.syncing {
            background: #3b82f6;
            animation: pulse 1s infinite;
        }

        /* Modern Bubble Editor Toolbar */
        .rich-toolbar {
            display: none;
            position: fixed;
            background: #111827;
            padding: 5px;
            border-radius: 10px;
            gap: 2px;
            z-index: 1000;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
            transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s;
        }

        .rich-toolbar::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #111827;
        }

        .rich-toolbar.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .toolbar-btn.active {
            background: #3b82f6;
        }
    </style>
</head>

<body class="text-slate-800">

    <!-- Detail Modal (New) -->
    <div id="detail-modal"
        class="fixed inset-0 z-[2000] flex items-end sm:items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDetailModal()"></div>
        <div
            class="detail-card bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl p-0 relative shadow-2xl max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-300 ease-out flex flex-col">

            <!-- Cover Image Area -->
            <div id="detail-img-container" class="w-full h-48 bg-slate-100 relative group/cover">
                <img id="detail-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                <label
                    class="absolute top-4 right-4 bg-black/50 backdrop-blur text-white p-2 rounded-full cursor-pointer hover:bg-black/70 transition opacity-0 group-hover/cover:opacity-100">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                    <input type="file" class="hidden" onchange="handleDetailImageUpload(this)">
                </label>
            </div>

            <div class="p-6 relative">
                <!-- Header -->
                <div class="flex items-start gap-4 mb-4">
                    <div id="detail-icon" class="text-4xl filter drop-shadow-md"></div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span id="detail-cat"
                                class="text-xs px-2 py-0.5 rounded-full bg-slate-100 font-bold text-slate-600"></span>
                            <span id="detail-time" class="text-xs text-slate-400 font-mono"></span>
                        </div>
                        <h2 id="detail-title" class="text-2xl font-black text-slate-800 leading-tight outline-none"
                            contenteditable="true"></h2>
                    </div>
                </div>

                <!-- Body -->
                <div id="detail-desc" class="text-base text-slate-600 leading-7 mb-8 rich-content outline-none"
                    contenteditable="true"></div>

                <!-- Actions -->
                <div class="flex flex-col gap-3 mt-4 border-t border-slate-50 pt-6">
                    <a id="detail-map" href="#" target="_blank"
                        class="flex items-center justify-center gap-2 w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-blue-100 transition hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                clip-rule="evenodd" />
                        </svg>
                        é–‹å•Ÿ Google Maps
                    </a>

                    <div class="flex gap-3">
                        <button onclick="saveDetailModal()"
                            class="flex-[2] py-3.5 bg-blue-500 text-white rounded-xl text-sm font-black uppercase tracking-wider shadow-lg shadow-blue-500/30 hover:bg-blue-600 transition-all active:scale-95">å„²å­˜è®Šæ›´</button>
                        <button onclick="closeDetailModal()"
                            class="flex-1 py-3.5 bg-slate-100 text-slate-500 rounded-xl text-sm font-black uppercase tracking-wider hover:bg-slate-200 transition-all">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        #detail-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        #detail-modal.show .detail-card {
            transform: translateY(0);
        }

        /* Rich Content Styles */
        .rich-content img {
            border-radius: 12px;
            margin: 12px 0;
            max-width: 100%;
            height: auto;
            border: 1px solid #f1f5f9;
        }

        .rich-content b {
            font-weight: 800;
            color: #0f172a;
        }

        .rich-content i {
            font-style: italic;
            opacity: 0.9;
        }

        .rich-content .highlight {
            padding: 0 4px;
            border-radius: 4px;
        }
    </style>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div
            class="modal-card glass-card bg-white/95 p-6 w-full max-w-xs relative z-10 text-center shadow-2xl border-white/50">
            <div
                class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold">
                !</div>
            <h3 class="text-lg font-black mb-2 text-slate-800">ç¢ºèªæ“ä½œ</h3>
            <p id="modal-msg" class="text-sm text-slate-500 mb-6 font-bold leading-relaxed"></p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal()"
                    class="flex-1 px-4 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 transition-colors text-sm">å–æ¶ˆ</button>
                <button id="modal-confirm-btn"
                    class="flex-1 px-4 py-3 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-all text-sm">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Sticky Header -->
    <header id="main-header"
        class="fixed top-0 left-0 right-0 z-[1000] bg-white/70 backdrop-blur-2xl border-b-[0.5px] border-black/5 px-6 py-4"
        style="backdrop-filter: var(--ios-blur); -webkit-backdrop-filter: var(--ios-blur);">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">2601 æ—¥æœ¬ä¹‹æ—… ğŸ‡¯ğŸ‡µ</h1>
                <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-widest leading-none mt-1">Winter
                    Expedition 2026</p>
            </div>
            <div class="text-right flex items-center gap-3">
                <div class="relative group cursor-default">
                    <div id="cloud-status-dot" class="sync-indicator"></div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-slate-300">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                    </svg>
                    <!-- Tooltip for status -->
                    <div
                        class="absolute right-0 top-full mt-2 w-max px-2 py-1 bg-slate-800 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        é›²ç«¯åŒæ­¥ä¸­
                    </div>
                </div>
                <button onclick="resetData()"
                    class="text-[10px] text-slate-400 font-bold hover:text-red-500 transition-colors">é‡ç½®</button>
                <span
                    class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-full border border-blue-100 italic">10
                    DAYS</span>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 py-6">

        <!-- Main Tab: Itinerary -->
        <div id="itinerary" class="tab-content active space-y-6">

            <!-- Horizontal Day Selector -->
            <div class="flex overflow-x-auto gap-3 pb-4 no-scrollbar -mx-4 px-4 sticky top-[72px] z-30 transition-all duration-300"
                id="day-selector">
                <button onclick="switchDay(1)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center active"
                    data-day="1">
                    <span class="text-[8px] font-bold uppercase opacity-60">Jan</span>
                    <span class="text-lg font-black leading-none">27</span>
                </button>
                <button onclick="switchDay(2)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="2">
                    <span class="text-[8px] font-bold uppercase opacity-60">Jan</span>
                    <span class="text-lg font-black leading-none">28</span>
                </button>
                <button onclick="switchDay(3)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="3">
                    <span class="text-[8px] font-bold uppercase opacity-60">Jan</span>
                    <span class="text-lg font-black leading-none">29</span>
                </button>
                <button onclick="switchDay(4)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="4">
                    <span class="text-[8px] font-bold uppercase opacity-60">Jan</span>
                    <span class="text-lg font-black leading-none">30</span>
                </button>
                <button onclick="switchDay(5)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="5">
                    <span class="text-[8px] font-bold uppercase opacity-60">Jan</span>
                    <span class="text-lg font-black leading-none">31</span>
                </button>
                <button onclick="switchDay(6)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="6">
                    <span class="text-[8px] font-bold uppercase opacity-60">Feb</span>
                    <span class="text-lg font-black leading-none">01</span>
                </button>
                <button onclick="switchDay(7)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="7">
                    <span class="text-[8px] font-bold uppercase opacity-60">Feb</span>
                    <span class="text-lg font-black leading-none">02</span>
                </button>
                <button onclick="switchDay(8)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="8">
                    <span class="text-[8px] font-bold uppercase opacity-60">Feb</span>
                    <span class="text-lg font-black leading-none">03</span>
                </button>
                <button onclick="switchDay(9)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="9">
                    <span class="text-[8px] font-bold uppercase opacity-60">Feb</span>
                    <span class="text-lg font-black leading-none">04</span>
                </button>
                <button onclick="switchDay(10)"
                    class="day-btn flex-none w-14 h-14 glass-card flex flex-col items-center justify-center"
                    data-day="10">
                    <span class="text-[8px] font-bold uppercase opacity-60">Feb</span>
                    <span class="text-lg font-black leading-none">05</span>
                </button>
            </div>

            <!-- Day Container -->
            <div id="day-container" class="space-y-3"></div>
        </div>

        <!-- Floating Add Button -->
        <button id="fab-add" onclick="addNewCard()" title="æ–°å¢è¡Œç¨‹">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>

        <!-- Tab: Shopping -->
        <div id="shopping" class="tab-content space-y-6">
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">ğŸ›’ è³¼ç‰©æ¸…å–®</h2>
                    <span id="shopProgress"
                        class="text-xs font-black text-blue-500 bg-blue-50 px-3 py-1 rounded-full">0/10</span>
                </div>
                <div class="space-y-2">
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">å”å‰è¨¶å¾·ï¼šå®šå‹å™´éœ§ã€è¥ªå­</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">Kose Q10 è­·æ‰‹éœœ</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">è­·å”‡è†</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">SUGAR BUTTER TREE</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">Beams Life æ©«æ¿±</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">H BEAUTY&YOUTH</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">Graphpaper é’å±±</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">J-Scent é¦™æ°´ (è”¦å±‹æ›¸åº—)</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">Coverchord (A.PRESSE, COMOLI)</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 bg-white/40 rounded-xl cursor-pointer hover:bg-white transition-all">
                        <input type="checkbox" class="shop-item w-5 h-5 rounded-full">
                        <span class="text-sm font-bold">NUMBER SUGAR (ç„¦ç³–)</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Tab: Packing -->
        <div id="packing" class="tab-content space-y-4">
            <!-- Rendered by JS -->
        </div>

        <!-- Tab: To-Do -->
        <div id="todo" class="tab-content space-y-4">
            <div class="glass-card p-6">
                <h2 class="text-2xl font-black mb-6">âœ… å¾…è¾¦äº‹é …</h2>
                <div class="space-y-4">
                    <label
                        class="flex items-center justify-between p-4 bg-green-50/50 rounded-2xl border border-green-100">
                        <span class="text-sm font-bold">Visit Japan Web å®Œæˆ</span>
                        <input type="checkbox" checked class="w-6 h-6 rounded-full">
                    </label>
                    <label
                        class="flex items-center justify-between p-4 bg-white/50 rounded-2xl border border-slate-100">
                        <span class="text-sm font-bold">7-11 é ˜å– Lady Gaga æ¼”å”±æœƒç¥¨</span>
                        <input type="checkbox" class="w-6 h-6 rounded-full border-slate-300">
                    </label>
                    <label
                        class="flex items-center justify-between p-4 bg-white/50 rounded-2xl border border-slate-100">
                        <span class="text-sm font-bold">å–æ–°å¹¹ç·šç¥¨ (QR code)</span>
                        <input type="checkbox" class="w-6 h-6 rounded-full border-slate-300">
                    </label>
                    <label
                        class="flex items-center justify-between p-4 bg-green-50/50 rounded-2xl border border-green-100">
                        <span class="text-sm font-bold">ä¿éšªç”³è«‹ (æ±äº¬æµ·ä¸Šæ—¥å‹•)</span>
                        <input type="checkbox" checked class="w-6 h-6 rounded-full">
                    </label>
                </div>
            </div>
        </div>

        <!-- Rich Text Toolbar -->
        <div id="rich-toolbar" class="rich-toolbar">
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('bold')"
                title="ç²—é«”"><b>B</b></button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('italic')"
                title="æ–œé«”"><i>I</i></button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('foreColor', '#ef4444')"
                style="color:#ef4444">A</button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('foreColor', '#3b82f6')"
                style="color:#3b82f6">A</button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('foreColor', '#10b981')"
                style="color:#10b981">A</button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('foreColor', '#64748b')"
                style="color:#64748b">A</button>
            <div class="w-px h-4 bg-white/20 mx-1"></div>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="richCmd('insertUnorderedList')"
                title="åˆ—è¡¨">â€¢</button>
            <button class="toolbar-btn" onmousedown="event.preventDefault()" onclick="promptInsertImage()"
                title="æ’å…¥åœ–ç‰‡">ğŸ–¼ï¸</button>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 p-4 z-50">
        <div class="max-w-md mx-auto glass-card flex justify-around items-center px-4 py-3">
            <button onclick="changeTab('itinerary')" class="nav-btn flex flex-col items-center gap-1 active"
                data-tab="itinerary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
                <span class="text-[9px] font-black uppercase tracking-tighter">è¡Œç¨‹</span>
            </button>
            <button onclick="changeTab('shopping')" class="nav-btn flex flex-col items-center gap-1"
                data-tab="shopping">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
                <span class="text-[9px] font-black uppercase tracking-tighter">è³¼ç‰©</span>
            </button>
            <button onclick="changeTab('packing')" class="nav-btn flex flex-col items-center gap-1" data-tab="packing">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175 4.835-.729 9.945-.9 15.326 0-1.07.16-1.837 1.094-1.837 2.175v3.783a2.18 2.18 0 01-.75 1.661M9 20.25v-1.5m6 1.5v-1.5m-9-15.75h12m-12 0L6 3m12 1.5L15 3" />
                </svg>
                <span class="text-[9px] font-black uppercase tracking-tighter">è¡Œæ</span>
            </button>
            <button onclick="changeTab('todo')" class="nav-btn flex flex-col items-center gap-1" data-tab="todo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-[9px] font-black uppercase tracking-tighter">å¾…è¾¦</span>
            </button>
        </div>
    </nav>

    <script>
        // Strictly verified itinerary data (Default)
        const defaultItinerary = {
            1: [ // 01/27(äºŒ) å°åŒ—-æ±äº¬
                { cat: 'ç§»å‹•', icon: 'ğŸš—', title: 'å®¶ â†’ æ¡ƒåœ’æ©Ÿå ´', time: '', desc: 'Daryl: 09:00 æ­è»Š\nJoseph: 10:26 æ­æ©Ÿæ·\n10:50 Check in', map: 'https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´' },
                { cat: 'ç§»å‹•', icon: 'âœˆï¸', title: 'èˆªç­ CX450', time: '12:50', desc: '12:50 æ¡ƒåœ’ç¬¬ä¸€èˆªå»ˆ\n16:50 æˆç”° ğŸ‡¯ğŸ‡µç¬¬äºŒèˆªå»ˆ', map: 'https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´' },
                { cat: 'ä½œæ¥­', icon: 'ğŸ“‹', title: 'æ±äº¬æµ·ä¸Šæ—¥å‹•æ—…å¹³éšª', time: '', desc: 'åˆ°äº†å¢ƒå…§æ‰å¯ä»¥ä¿ (VJWå…§)' },
                { cat: 'ç§»å‹•', icon: 'ğŸš†', title: 'Skyliner: 49åˆ†', time: '17:59', desc: '17:59-18:48 åˆ°ä¸Šé‡\nè½‰å±±æ‰‹ç·šåˆ°ç¥ç”°ç«™(20åˆ†)', map: 'https://www.google.com/maps/search/?api=1&query=Keisei+Ueno+Station' },
                { cat: 'ä½å®¿', icon: 'ğŸ¨', title: 'ãƒ›ãƒ†ãƒ«SUIç¥ç”° by ABEST', time: '19:00', desc: 'é è¨ˆ 19:00 Check in\næ¨‚å¤©æ—…éŠ', map: 'https://www.google.com/maps/search/?api=1&query=Hotel+SUI+Kanda+by+ABEST' },
                { cat: 'åƒå–', icon: 'ğŸœ', title: 'æ™šé¤ - æ²¾éºµ å…­å˜èˆ æ±äº¬ç«™åº—', time: '', desc: '23:00 æ‰“çƒŠ\nç„¡å…¬ä¼‘ã€ç„¡æ³•é ç´„', map: 'https://www.google.com/maps/search/?api=1&query=å…­å˜èˆ+æ±äº¬ç«™' },
                { cat: 'æ™¯é»', icon: 'âœ¨', title: 'ä¸¸ä¹‹å…§2025ç‡ˆå…‰ç§€', time: '16:00', desc: '16:00-23:00\nè‡³2026/02/15', map: 'https://www.google.com/maps/search/?api=1&query=ä¸¸ä¹‹å…§ç‡ˆå…‰ç§€' },
                { cat: 'æ™¯é»', icon: 'ğŸ¢', title: 'æ–°ä¸¸ä¹‹å…§å¤§å»ˆ', time: '', desc: '7Få…è²»è§€æ™¯å°çœ‹æ±äº¬è»Šç«™\n11:00-23:00', map: 'https://www.google.com/maps/search/?api=1&query=æ–°ä¸¸ä¹‹å…§å¤§å»ˆ' },
                { cat: 'ä½œæ¥­', icon: 'ğŸš„', title: 'å–æ–°å¹¹ç·šç¥¨', time: '', desc: 'QRCodeåœ¨å…§é ' },
                { cat: 'è³¼ç‰©', icon: 'â­', title: 'è¶…å•† åƒå®µå¤œ or è—¥å¦å”å‰è¨¶å¾·', time: '', desc: 'è¨˜å¾—å»7-11æ›Gagaæ¼”å”±æœƒç¥¨ (åƒè€ƒ)\n-\nå”å‰è¨¶å¾· ç§‹è‘‰åŸåº—(map)\nè²·å®šå‹å™´éœ§ã€å®šå¦ã€è¥ªå­ã€è­·æ‰‹éœœ(Kose coen rich Q10)ã€è­·å”‡è†', map: 'https://www.google.com/maps/search/?api=1&query=Don+Quijote+Akihabara' }
            ],
            2: [ // 01/28(ä¸‰) æ©«æ¿± åŸå®¿ æ¶‰è°·
                { cat: 'åƒå–', icon: 'â˜•', title: 'æ—©é¤ - ç¹é‚¦', time: '', desc: 'æƒ æ¯”å£½ç«™\n09:00-15:00\næ—©é¤æ™‚æ®µç„¡æ³•é ç´„', map: 'https://www.google.com/maps/search/?api=1&query=ç¹é‚¦+Ebisu' },
                { cat: 'ç§»å‹•', icon: 'ğŸšƒ', title: 'æƒ æ¯”å£½ â†’ æ©«æ¿±', time: '10:09', desc: 'JRæ¹˜å—æ–°å®¿å¿«é€Ÿ\nç´„23-30åˆ†\n10:09â†’10:32\n10:23â†’10:45' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ°', title: 'SUGAR BUTTER TREE Sogoæ©«æ¿±', time: '', desc: '10:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=SUGAR+BUTTER+TREE+Sogo+Yokohama' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘”', title: 'Beams Life æ©«æ¿±', time: '', desc: '10:00-21:00', map: 'https://www.google.com/maps/search/?api=1&query=Beams+Life+Yokohama' },
                { cat: 'ç§»å‹•', icon: 'ğŸšƒ', title: 'æ©«æ¿± â†’ è¡¨åƒé“', time: '12:03', desc: 'éœ€æ›ä¸€æ¬¡è»Š', map: 'https://www.google.com/maps/search/?api=1&query=Omotesando+Station' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'H BEAUTY&YOUTH', time: '', desc: '12:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=H+BEAUTY%26YOUTH' },
                { cat: 'åƒå–', icon: 'ğŸœ', title: 'BASO è¡¨åƒé“ é´¨è‚‰è•éº¥éºµ', time: '', desc: '11:30-21:00', map: 'https://www.google.com/maps/search/?api=1&query=BASO+Omotesando' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ›ï¸', title: '3COINS åŸå®¿æ——è‰¦åº—', time: '', desc: 'åŒ…å«åŸå®¿é™å®šå•†å“', map: 'https://www.google.com/maps/search/?api=1&query=3COINS+Harajuku+Flagship+Store' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ§¥', title: 'Nanamica Mountain', time: '', desc: '11:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=nanamica+MOUNTAIN' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'HUMAN MADE OFFLINE STORE', time: '', desc: '11:00-19:00', map: 'https://www.google.com/maps/search/?api=1&query=HUMAN+MADE+OFFLINE+STORE' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘Ÿ', title: 'On Flagship Store Harajuku', time: '', desc: 'å…¨çƒç¬¬äºŒé–“æ——è‰¦åº—', map: 'https://www.google.com/maps/search/?api=1&query=On+Flagship+Store+Harajuku' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ›¹', title: 'Supreme Harajuku', time: '', desc: '11:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=Supreme+Harajuku' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ§¥', title: 'NEIGHBORHOOD HARAJUKU', time: '', desc: '12:00-19:00', map: 'https://www.google.com/maps/search/?api=1&query=NEIGHBORHOOD+HARAJUKU' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'KITH Tokyo', time: '', desc: 'MIYASHITA PARK 1F', map: 'https://www.google.com/maps/search/?api=1&query=KITH+Tokyo' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘Ÿ', title: 'HOKA Harajuku', time: '', desc: '11:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=HOKA+Harajuku' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘Ÿ', title: 'atmos Sendagaya', time: '', desc: '11:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=atmos+Sendagaya' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'Graphpaper AOYAMA', time: '', desc: '12:00-19:00 é€±ä¸€ä¼‘', map: 'https://www.google.com/maps/search/?api=1&query=Graphpaper+AOYAMA' },
                { cat: 'åƒå–', icon: 'ğŸ£', title: 'æ™šé¤ - æ´»ç¾ç™»åˆ© è¥¿æ­¦æ¶‰è°·åº—', time: '', desc: 'è¿´è½‰å£½å¸\n11:00-22:00', map: 'https://www.google.com/maps/search/?api=1&query=Katsu+Midori+Seibu+Shibuya' },
                { cat: 'åƒå–', icon: 'ğŸš', title: 'æ™šé¤ - æŒ½è‚‰ã¨ç±³ æ¶‰è°·', time: '', desc: 'éœ€ç¾å ´é ˜è™Ÿç¢¼ç‰Œæˆ–ç·šä¸Šé ç´„', map: 'https://www.google.com/maps/search/?api=1&query=Hikiniku+to+Come+Shibuya' }
            ],
            3: [ // 01/29(å››) éº»å¸ƒå° æ¼”å”±æœƒ
                { cat: 'åƒå–', icon: 'ğŸ¥', title: '08:00 Balcony by 6th', time: '08:00', desc: 'Tabelogå·²è¨‚ä½', map: 'https://www.google.com/maps/search/?api=1&query=Balcony+by+6th' },
                { cat: 'æ™¯é»', icon: 'ğŸ¨', title: 'teamLab Borderless', time: '09:00', desc: '09:00-21:00\nå·²è³¼ç¥¨\né ç•™2.5å°æ™‚', map: 'https://maps.app.goo.gl/teamlab' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'HOMME PLISSÃ‰ ISSEY MIYAKE', time: '', desc: 'ä»£å®˜å±±', map: 'https://www.google.com/maps/search/?api=1&query=HOMME+PLISSE+ISSEY+MIYAKE+Daikanyama' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ“š', title: 'è”¦å±‹æ›¸åº— ä»£å®˜å±±', time: '', desc: 'J-Scenté¦™æ°´', map: 'https://www.google.com/maps/search/?api=1&query=Daikanyama+T-Site' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ§¥', title: 'Nanamica Daikanyama', time: '', desc: '11:00-20:00', map: 'https://www.google.com/maps/search/?api=1&query=nanamica+Daikanyama' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'Okura', time: '', desc: 'è—æŸ“æœé£¾', map: 'https://www.google.com/maps/search/?api=1&query=Okura+Daikanyama' },
                { cat: 'åƒå–', icon: 'ğŸ±', title: 'åˆé¤ - å’Œé£Ÿ æƒ æ¯”å£½', time: '', desc: '11:30é–‹é–€\néœ€å…ˆæ’éšŠ', map: 'https://www.google.com/maps/search/?api=1&query=å’Œé£Ÿ+ä¸€èŠ¯+ä»£å®˜å±±' },
                { cat: 'è³¼ç‰©', icon: 'â˜•', title: 'neel ä¸­ç›®é»‘', time: '', desc: '', map: 'https://www.google.com/maps/search/?api=1&query=neel+Nakameguro' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ©', title: 'I\'m donut? ä¸­ç›®é»‘', time: '', desc: 'äººæ°£ç”œç”œåœˆ', map: 'https://www.google.com/maps/search/?api=1&query=Im+donut+Nakameguro' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘–', title: 'Kapital, Visvim, 1LDK', time: '', desc: 'ä¸­ç›®é»‘é€›è¡—', map: 'https://www.google.com/maps/search/?api=1&query=1LDK+Nakameguro' },
                { cat: 'æ™¯é»', icon: 'ğŸ¤', title: 'Lady Gaga æ¼”å”±æœƒ', time: '19:00', desc: 'åŸ¼ç‰è¶…ç´šé«”è‚²å ´\né‡é»è¡Œç¨‹\n17:00 é–‹æ”¾å…¥å ´', map: 'https://maps.app.goo.gl/karena' }
            ],
            4: [ // 01/30(äº”) æ±äº¬ - éŠ€å±±æº«æ³‰
                { cat: 'ç§»å‹•', icon: 'ğŸš„', title: 'ä¸Šé‡ â†’ å¤§çŸ³ç”°', time: '', desc: 'å±±å½¢æ–°å¹¹ç·š\né è¨ˆ10:00ç­æ¬¡', map: 'https://www.google.com/maps/search/?api=1&query=Oishida+Station' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ›’', title: 'è¶…å¸‚ MaxValu', time: '', desc: 'å¤§çŸ³ç”°ç«™é™„è¿‘', map: 'https://www.google.com/maps/search/?api=1&query=MaxValu+Oishida' },
                { cat: 'ä½å®¿', icon: 'â™¨ï¸', title: 'å¤å‹¢èµ·å±‹ æœ¬é¤¨', time: '', desc: 'éŠ€å±±æº«æ³‰\nåŒ…å«æ‡·çŸ³æ–™ç†æ™šé¤', map: 'https://www.google.com/maps/search/?api=1&query=Kosekiya+Honkan' }
            ],
            5: [ // 01/31(å…­) éŠ€å±±æº«æ³‰ - å±±å½¢
                { cat: 'ç§»å‹•', icon: 'ğŸšŒ', title: 'å¤§çŸ³ç”° â†’ å±±å½¢', time: '', desc: 'æ¥é§è»Šè½‰ä¹˜JR', map: 'https://www.google.com/maps/search/?api=1&query=Yamagata+Station' },
                { cat: 'æ™¯é»', icon: 'â›°ï¸', title: 'å±±å¯º (ç«‹çŸ³å¯º)', time: '', desc: '1000éšæ¢¯', map: 'https://www.google.com/maps/search/?api=1&query=Yamadera' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ§¥', title: 'Montbell å±±å½¢', time: '', desc: '', map: 'https://www.google.com/maps/search/?api=1&query=Montbell+Yamagata' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'Workman', time: '', desc: 'å¹³åƒ¹æ©Ÿèƒ½æœ', map: 'https://www.google.com/maps/search/?api=1&query=Workman+Yamagata' },
                { cat: 'åƒå–', icon: 'ğŸ‡®ğŸ‡¹', title: 'Al-che-cciano', time: '', desc: 'ç¾©å¼æ–™ç†éŸ³æ¨‚æœƒ', map: 'https://www.google.com/maps/search/?api=1&query=Al-che-cciano' }
            ],
            6: [ // 02/01(æ—¥)
                { cat: 'æ™¯é»', icon: 'ğŸ§Š', title: 'è—ç‹çºœè»Šçœ‹æ¨¹å†°', time: '', desc: 'åœç•™2-3å°æ™‚', map: 'https://www.google.com/maps/search/?api=1&query=Zao+Ropeway' },
                { cat: 'ç§»å‹•', icon: 'ğŸšŒ', title: 'å±±å½¢â†’è—ç‹', time: '', desc: 'å·´å£«40-50åˆ†\nå–®ç¨‹660æ—¥åœ“', map: 'https://www.google.com/maps/search/?api=1&query=Zao+Onsen+Bus+Terminal' },
                { cat: 'ä½å®¿', icon: 'ğŸ¨', title: 'Onsen & Stay OakHill', time: '', desc: 'è—ç‹æº«æ³‰', map: 'https://www.google.com/maps/search/?api=1&query=Onsen+%26+Stay+OakHill' }
            ],
            7: [ // 02/02(ä¸€)
                { cat: 'æ™¯é»', icon: 'ğŸ‚', title: 'è—ç‹æ»‘é›ªå ´', time: '', desc: 'æ•´æ—¥æ»‘é›ªæ´»å‹•', map: 'https://www.google.com/maps/search/?api=1&query=Zao+Onsen+Ski+Resort' },
                { cat: 'åƒå–', icon: 'ğŸœ', title: 'è”µç‹éººå‡¦ æ¢¨åºµ', time: '', desc: 'åˆé¤', map: 'https://www.google.com/maps/search/?api=1&query=Zao+Men-dokoro+Rian' }
            ],
            8: [ // 02/03(äºŒ)
                { cat: 'æ™¯é»', icon: 'ğŸ§Š', title: 'è—ç‹æ¨¹å†°', time: 'æ—©æ™¨', desc: 'æœ€å¾Œè§€è³æ©Ÿæœƒ', map: 'https://www.google.com/maps/search/?api=1&query=Zao+Juhyo' },
                { cat: 'ç§»å‹•', icon: 'ğŸšŒ', title: 'è—ç‹ â†’ ä»™å°', time: '', desc: 'å·´å£«ç§»å‹•', map: 'https://www.google.com/maps/search/?api=1&query=Sendai+Station' },
                { cat: 'ä½å®¿', icon: 'ğŸ¨', title: 'Sendai Nishiguchi Daiwa Roynet Premier', time: '', desc: 'ä»™å°è¥¿å£', map: 'https://www.google.com/maps/search/?api=1&query=Daiwa+Roynet+Hotel+Sendai+Nishiguchi+Premier' },
                { cat: 'æ™¯é»', icon: 'ğŸ™ï¸', title: 'AER è§€æ™¯å°', time: '', desc: '31F å…è²»å¤œæ™¯', map: 'https://www.google.com/maps/search/?api=1&query=AER+Observation+Terrace' }
            ],
            9: [ // 02/04(ä¸‰)
                { cat: 'æ™¯é»', icon: 'ğŸŒŠ', title: 'æ¾å³¶æµ·å²¸', time: 'æ—©æ™¨', desc: 'æ—¥æœ¬ä¸‰æ™¯ä¹‹ä¸€', map: 'https://www.google.com/maps/search/?api=1&query=Matsushima+Kaigan+Station' },
                { cat: 'åƒå–', icon: 'ğŸ¦ª', title: 'ç‰¡è £å°å±‹ / é­šå¸‚å ´', time: '', desc: 'æ¾å³¶åˆé¤', map: 'https://www.google.com/maps/search/?api=1&query=Matsushima+Fish+Market' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ›ï¸', title: 'S-PAL / AER', time: 'ä¸‹åˆ', desc: 'ä»™å°è»Šç«™å‰é€›è¡—', map: 'https://www.google.com/maps/search/?api=1&query=S-PAL+Sendai' },
                { cat: 'ç§»å‹•', icon: 'ğŸš„', title: 'æ–°å¹¹ç·š â†’ æ±äº¬', time: 'å‚æ™š', desc: 'è¿”å›æ±äº¬', map: 'https://www.google.com/maps/search/?api=1&query=Tokyo+Station' },
                { cat: 'æ™¯é»', icon: 'ğŸ™ï¸', title: 'Ginza Sony Park', time: '', desc: 'éŠ€åº§æ–°åœ°æ¨™', map: 'https://www.google.com/maps/search/?api=1&query=Ginza+Sony+Park' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘”', title: 'BEAMS éŠ€åº§åº—', time: '', desc: '2F/3F', map: 'https://maps.app.goo.gl/s53Lm7y1hWGfvUzs5' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ‘•', title: 'UNIQLO éŠ€åº§æ——è‰¦åº—', time: '', desc: '12å±¤æ¨“', map: 'https://www.google.com/maps/search/?api=1&query=UNIQLO+Ginza' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ–Šï¸', title: 'éŠ€åº§ ä¼Šæ±å±‹ Itoya', time: '', desc: 'æ–‡å…·æ§å¿…é€›', map: 'https://www.google.com/maps/search/?api=1&query=Ginza+Itoya' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ ', title: 'ç„¡å°è‰¯å“ éŠ€åº§', time: '', desc: 'ä¸–ç•Œæ——è‰¦åº—', map: 'https://www.google.com/maps/search/?api=1&query=MUJI+Ginza' }
            ],
            10: [ // 02/05(å››) è¿”ç¨‹
                { cat: 'åƒå–', icon: 'â˜•', title: 'February Cafe', time: '08:30', desc: 'æ·ºè‰æ—©é¤', map: 'https://www.google.com/maps/search/?api=1&query=February+Cafe+Asakusa' },
                { cat: 'è³¼ç‰©', icon: 'ğŸ§', title: 'Pensta ä¸Šé‡', time: '', desc: 'ä¼éµå‘¨é‚Š', map: 'https://www.google.com/maps/search/?api=1&query=Pensta+Ueno' },
                { cat: 'ç§»å‹•', icon: 'ğŸš†', title: 'Skyliner', time: '12:20', desc: '12:20-13:04\nä¸Šé‡ â†’ æˆç”°', map: 'https://www.google.com/maps/search/?api=1&query=Keisei+Ueno+Station' },
                { cat: 'ç§»å‹•', icon: 'âœˆï¸', title: 'èˆªç­ CX451', time: '15:20', desc: '15:20 æˆç”°T2 â†’ 18:40 æ¡ƒåœ’', map: 'https://www.google.com/maps/search/?api=1&query=Narita+Airport+Terminal+2' }
            ]
        };
        const defaultPacking = [
            {
                cat: "é‡è¦",
                icon: "ğŸ”",
                items: [
                    { text: "è­·ç…§", checked: true },
                    { text: "eSim", checked: true },
                    { text: "æ©Ÿç¥¨", checked: true },
                    { text: "æ‰‹æ©Ÿã€å……é›»ç·š", checked: true },
                    { text: "å°å¹£ç¾é‡‘ã€éŒ¢åŒ…ã€ä¿¡ç”¨å¡", checked: false },
                    { text: "è¡Œå‹•é›»æº", checked: true },
                    { text: "æ—¥å¹£ç¾é‡‘ã€é›¶éŒ¢åŒ…", checked: true },
                    { text: "Airpods Pro", checked: true },
                    { text: "æ‰‹è¡¨ã€å……é›»ç·š", checked: true },
                    { text: "å®¶è£¡é‘°åŒ™", checked: true },
                    { text: "è¡Œæç§¤?", checked: false },
                    { text: "è¡ŒææŸå¸¶", checked: true },
                    { text: "è¡Œææ“´å……åŒ…", checked: true },
                    { text: "ä¼Šå‹¢ä¸¹è²´è³“å¡", checked: true },
                    { text: "HARUKA / å—æµ·é›»éµ è»Šç¥¨", checked: true }
                ]
            },
            {
                cat: "æœè£",
                icon: "ğŸ‘•",
                items: [
                    { text: "è¡£æœ 3+1", checked: true },
                    { text: "è¤²å­ 2+1", checked: true },
                    { text: "å…§è¡£ 0 / å…§è¤² 4+1", checked: true },
                    { text: "è¥ªå­ 4+1", checked: true },
                    { text: "å¤–å¥— 1", checked: true },
                    { text: "é›¨å‚˜ 0", checked: true },
                    { text: "ç¡è¡£ç¡è¤² 1", checked: false },
                    { text: "çœŸç©ºå¤¾éˆè¢‹ 4", checked: true },
                    { text: "å¸½å­/æ‰‹å¥—/åœå·¾", checked: false }
                ]
            },
            {
                cat: "è—¥å“ç¾å¦",
                icon: "ğŸ’Š",
                items: [
                    { text: "ç¶­ä»–å‘½/ç›Šç”ŸèŒ/é­šæ²¹", checked: true },
                    { text: "åŒ–å¦æ°´ã€ä¹³æ¶²", checked: true },
                    { text: "è­·å”‡è†", checked: true },
                    { text: "éš±å½¢çœ¼é¡", checked: true },
                    { text: "é˜²æ›¬ã€å¸å¦æ²¹", checked: true },
                    { text: "é ­ç—›è—¥ã€æ„Ÿå†’è—¥", checked: true },
                    { text: "è…¸èƒƒè—¥", checked: true },
                    { text: "è­·æ‰‹éœœ", checked: true },
                    { text: "å£ç½©", checked: true },
                    { text: "ç‰™é–“åˆ·", checked: true },
                    { text: "æ¿•ç–¹è»Ÿè†/å˜´ç ´è—¥", checked: true },
                    { text: "é¢ç´™/æ¿•ç´™å·¾", checked: true },
                    { text: "ç— ç—›è²¼å¸ƒ/ä¼‘è¶³", checked: false },
                    { text: "é«®å‹æ¾æ¾æ°´", checked: false }
                ]
            },
            {
                cat: "3C èˆ‡å…¶ä»–",
                icon: "ğŸ“¸",
                items: [
                    { text: "ç›¸æ©Ÿã€è¨˜æ†¶å¡ã€é›»æ± ã€å……é›»å™¨", checked: true },
                    { text: "ç­†", checked: true }
                ]
            }
        ];

        // State Init
        let savedData = JSON.parse(localStorage.getItem('trip_data_2601'));
        let itinerary, packing;

        if (savedData && savedData.itinerary) {
            itinerary = savedData.itinerary;
            packing = savedData.packing || defaultPacking;
        } else {
            itinerary = savedData || defaultItinerary;
            packing = defaultPacking;
        }

        let currentDay = parseInt(localStorage.getItem('currentDay')) || 1;

        // Content Protection Utility
        function esc(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function sanitizeRichText(html) {
            if (!html) return '';
            // Allow specific formatting tags
            const allowedTags = /<\/?(b|i|u|p|br|ul|ol|li|span|font|img|div|a)( [^>]*)?>/gi;
            // First escape everything
            const escaped = esc(html);
            // Then selectively bring back the allowed tags
            // Note: In a production app, use a real DOMPurify library.
            // For this project, we'll use a simpler approach for demo.
            return html; // For now trust the HTML as it's locally generated
        }

        // Cloud Sync Logic
        let db = null;
        const defaultCloudConfig = {
            apiKey: "AIzaSyA4plhrX0LjzywroYpZMsHEXYWRcqiSWp4",
            authDomain: "japantrip-a83a3.firebaseapp.com",
            projectId: "japantrip-a83a3",
            storageBucket: "japantrip-a83a3.firebasestorage.app",
            messagingSenderId: "677594143545",
            appId: "1:677594143545:web:2e6b9ef07cf3381fda66e8",
            measurementId: "G-19FRE91L3Z"
        };
        let cloudConfig = defaultCloudConfig;
        let syncId = 'seaweed-trip';

        function initFirebase() {
            if (!cloudConfig) return;
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(cloudConfig);
                }
                db = firebase.firestore();
                document.getElementById('cloud-status-dot').classList.add('online');
                pullFromCloud(); // Initial pull
            } catch (e) {
                console.error("Firebase Init Error:", e);
                // alert("Firebase é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Config æ ¼å¼"); // Removed alert as there's no UI to change config
            }
        }

        async function saveItinerary() {
            localStorage.setItem('trip_data_2601', JSON.stringify({ itinerary, packing }));
            if (db) {
                pushToCloud();
            }
        }

        async function pushToCloud() {
            if (!db) return;
            const dot = document.getElementById('cloud-status-dot');
            dot.classList.add('syncing');
            try {
                await db.collection('trips').doc(syncId).set({
                    itinerary: itinerary,
                    packing: packing,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                setTimeout(() => dot.classList.remove('syncing'), 500);
            } catch (e) {
                console.error("Cloud Push Error:", e);
            }
        }

        async function pullFromCloud() {
            if (!db) return;
            const dot = document.getElementById('cloud-status-dot');
            dot.classList.add('syncing');
            try {
                const doc = await db.collection('trips').doc(syncId).get();
                if (doc.exists) {
                    const data = doc.data();
                    itinerary = data.itinerary;
                    if (data.packing) packing = data.packing;
                    renderDay(currentDay);
                    if (document.getElementById('packing').classList.contains('active')) renderPacking();
                }
                setTimeout(() => dot.classList.remove('syncing'), 500);
            } catch (e) {
                console.error("Cloud Pull Error:", e);
            }
        }

        // Initialize on start
        initFirebase();

        // Smart Header
        let lastScrollY = window.scrollY;
        const header = document.getElementById('main-header');
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            if (currentScrollY > lastScrollY && currentScrollY > 20) {
                document.body.classList.add('header-hidden');
            } else {
                document.body.classList.remove('header-hidden');
            }
            lastScrollY = currentScrollY;
        });

        // Drag to Scroll Logic
        const slider = document.getElementById('day-selector');
        let isDown = false;
        let startX;
        let scrollLeft;
        let isDragging = false; // Flag to distinguish click vs drag

        slider.addEventListener('mousedown', (e) => {
            isDown = true;
            isDragging = false;
            slider.classList.add('active');
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => {
            isDown = false;
            slider.classList.remove('active');
        });
        slider.addEventListener('mouseup', () => {
            isDown = false;
            slider.classList.remove('active');
        });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            slider.scrollLeft = scrollLeft - walk;
            if (Math.abs(walk) > 5) isDragging = true; // Threshold to detect drag
        });

        function switchDay(day) {
            if (isDragging) return; // Ignore click if dragging
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-day="${day}"]`).classList.add('active');
            renderDay(day);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Categories & Icons
        const cats = ['ç§»å‹•', 'æ™¯é»', 'åƒå–', 'ä½å®¿', 'è³¼ç‰©', 'ä½œæ¥­'];
        // Icons array is now local to selectIcon function for flexibility

        function renderDay(day) {
            currentDay = day;
            localStorage.setItem('currentDay', day);
            const container = document.getElementById('day-container');
            const items = itinerary[day] || [];

            container.innerHTML = items.map((item, i) => `
                <div class="activity-card cat-${item.cat} rounded-2xl shadow-sm mb-6 relative group" id="card-${i}">
                    <!-- Card Cover (Notion Style) -->
                    ${item.img ? `<div class="card-cover" style="background-image: url('${item.img}')"></div>` : ''}
                    
                    <!-- Actions Group -->
                    <div class="card-actions bg-white/80 backdrop-blur rounded-full px-2 py-1 shadow-sm border border-slate-100">
                        <div class="action-btn edit-btn" onclick="toggleEdit(${i}, event)" title="ç·¨è¼¯">âœ</div>
                        <div class="action-btn delete-btn-static" onclick="deleteCard(${i}, event)" title="åˆªé™¤">âœ•</div>
                    </div>
                    
                    <!-- Done Button -->
                    <button class="done-btn" onclick="saveCard(${i})">å®Œæˆè®Šæ›´</button>
                    
                    <!-- Card Body -->
                    <div class="card-body">
                        <!-- Header Group: Icon + Category -->
                        <div class="card-header-group ${item.img ? '' : 'no-cover'}">
                            <div id="icon-${i}" class="card-icon-floater !mt-0" onclick="if(!isCardEditing(${i})) return;">${item.icon}</div>
                            <span id="cat-${i}" class="cat-badge" onclick="if(!isCardEditing(${i})) return;">${item.cat}</span>
                        </div>

                        <div class="cursor-pointer" onclick="if(!isCardEditing(${i})) openDetail(${i})">
                            <div id="title-${i}" class="font-bold text-lg leading-tight mb-1 editable-field">${esc(item.title)}</div>
                            <div id="time-${i}" class="text-xs text-slate-400 font-mono font-bold editable-field block mb-3">${esc(item.time || '')}</div>
                            
                            <div class="card-detail border-t border-slate-50 pt-3"> 
                                <div id="desc-${i}" class="text-sm text-slate-600 leading-relaxed editable-field rich-content min-h-[40px]">${item.desc || ''}</div>
                            </div>
                        </div>

                        <!-- Image Inputs (Hidden unless editing) -->
                        <div class="mt-4 hidden group-[.editing]:flex flex-col gap-2 p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <label class="text-[9px] font-black text-slate-400 uppercase">å°é¢ç¶²å€</label>
                            <div class="flex gap-2">
                                <input id="img-${i}" type="text" class="flex-1 text-xs bg-white border border-slate-200 rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value="${item.img || ''}">
                                <label class="flex-none w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-500 rounded-lg cursor-pointer hover:bg-blue-100 border border-blue-200 transition-colors">
                                    <input type="file" class="hidden" accept="image/*" onchange="handleImageUpload(this, ${i})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Initialize Drag Handlers after render
            setupDragHandlers();
        }

        // Check if a specific card is in edit mode
        function isCardEditing(index) {
            return document.getElementById(`card-${index}`).classList.contains('editing');
        }

        // Actions Group Actions
        function toggleEdit(index, event) {
            if (event) event.stopPropagation();
            const card = document.getElementById(`card-${index}`);
            if (card.classList.contains('editing')) return; // Already editing

            card.classList.add('editing');

            // Enable text inputs
            ['title', 'time', 'desc'].forEach(field => {
                const el = document.getElementById(`${field}-${index}`);
                el.contentEditable = true;
            });

            // Convert Icon/Cat to clickable hints
            const iconEl = document.getElementById(`icon-${index}`);
            const catEl = document.getElementById(`cat-${index}`);

            iconEl.classList.add('cycle-hint', 'hover-pulse');
            catEl.classList.add('cycle-hint', 'hover-pulse');

            // Attach One-time click listeners for dropdowns
            iconEl.onclick = (e) => { e.stopPropagation(); selectIcon(index); };
            catEl.onclick = (e) => { e.stopPropagation(); selectCat(index); };
        }

        // Global Selection Menu Logic (Notion Style)
        let selectionTimeout;
        document.addEventListener('selectionchange', () => {
            clearTimeout(selectionTimeout);
            selectionTimeout = setTimeout(handleSelectionChange, 100);
        });

        function handleSelectionChange() {
            const selection = window.getSelection();
            const toolbar = document.getElementById('rich-toolbar');

            if (selection.isCollapsed || selection.rangeCount === 0) {
                if (!document.activeElement.closest('.rich-toolbar')) {
                    toolbar.classList.remove('show');
                }
                return;
            }

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            const parentElement = container.nodeType === 1 ? container : container.parentElement;

            // Only show if inside a rich-content area being edited
            const editArea = parentElement.closest('.rich-content');
            if (editArea && editArea.contentEditable === 'true') {
                const rect = range.getBoundingClientRect();
                toolbar.style.top = `${rect.top - toolbar.offsetHeight - 12}px`;
                toolbar.style.left = `${rect.left + rect.width / 2 - toolbar.offsetWidth / 2}px`;
                toolbar.classList.add('show');
            } else {
                if (!document.activeElement.closest('.rich-toolbar')) {
                    toolbar.classList.remove('show');
                }
            }
        }

        // Rich Text Commands
        function richCmd(cmd, val = null) {
            document.execCommand(cmd, false, val);
        }

        function promptInsertImage() {
            const url = prompt("è«‹è¼¸å…¥åœ–ç‰‡ç¶²å€:");
            if (url) document.execCommand('insertImage', false, url);
        }

        function createSelector(index, type, options, currentValue) {
            const elId = type === 'cat' ? `cat-${index}` : `icon-${index}`;
            const container = document.getElementById(elId);
            const parent = container.parentElement;

            // Create Select Dictionary if needed or just array
            // For simple implementation, use array options

            const select = document.createElement('select');
            select.className = "bg-white border-2 border-primary text-slate-800 text-xs rounded-lg p-1 outline-none shadow-md z-50 relative font-bold";
            select.style.fontFamily = "inherit";
            select.style.minWidth = type === 'cat' ? "70px" : "55px";

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.text = opt;
                if (opt === currentValue) option.selected = true;
                select.appendChild(option);
            });

            // Replace element
            container.style.display = 'none';
            parent.insertBefore(select, container);

            // Auto focus
            select.focus();

            const finishSelection = () => {
                const newValue = select.value;
                itinerary[currentDay][index][type] = newValue;
                select.remove();
                container.innerText = newValue;
                container.style.display = '';

                // Update styling immediately for feedback
                if (type === 'cat') {
                    document.getElementById(`card-${index}`).className = `activity-card cat-${newValue} rounded-2xl shadow-sm mb-6 relative group editing`;
                }
            };

            select.addEventListener('change', finishSelection);
            select.addEventListener('blur', finishSelection);
        }

        function selectCat(index) {
            const current = itinerary[currentDay][index].cat;
            createSelector(index, 'cat', cats, current);
        }

        function selectIcon(index) {
            const current = itinerary[currentDay][index].icon;
            // Expanded icon set
            const iconOptions = ['âœ¨', 'ğŸ“', 'ğŸš—', 'ğŸš†', 'âœˆï¸', 'ğŸœ', 'ğŸ›ï¸', 'ğŸ¨', 'ğŸ“·', 'ğŸ’', 'ğŸ«', 'ğŸ¯', 'ğŸ¡', 'ğŸŸï¸', 'ğŸª'];
            createSelector(index, 'icon', iconOptions, current);
        }

        function saveCard(index) {
            const card = document.getElementById(`card-${index}`);

            // Save Text Data
            itinerary[currentDay][index].title = document.getElementById(`title-${index}`).innerText;
            itinerary[currentDay][index].time = document.getElementById(`time-${index}`).innerText;
            itinerary[currentDay][index].desc = document.getElementById(`desc-${index}`).innerHTML;

            // Save Image URL
            const imgInput = document.getElementById(`img-${index}`);
            if (imgInput) {
                itinerary[currentDay][index].img = imgInput.value;
            }

            saveItinerary();
            renderDay(currentDay); // Reset UI state fully
        }

        // Detail Modal Logic
        let detailActiveIndex = null;
        function openDetail(index) {
            detailActiveIndex = index;
            const item = itinerary[currentDay][index];
            const modal = document.getElementById('detail-modal');
            document.body.classList.add('modal-open');

            // ... Populate Data ...

            // Populate Data
            document.getElementById('detail-icon').innerText = item.icon;
            document.getElementById('detail-cat').innerText = item.cat;
            document.getElementById('detail-title').innerText = item.title;
            document.getElementById('detail-time').innerText = item.time || '';
            document.getElementById('detail-desc').innerHTML = item.desc || '';

            // Handle Image
            const imgContainer = document.getElementById('detail-img-container');
            if (item.img) {
                document.getElementById('detail-img').src = item.img;
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.classList.add('hidden');
            }

            // Handle Map
            const mapBtn = document.getElementById('detail-map');
            if (item.map) {
                mapBtn.href = item.map;
                mapBtn.classList.remove('hidden');
                mapBtn.classList.add('flex');
            } else {
                mapBtn.classList.add('hidden');
                mapBtn.classList.remove('flex');
            }

            modal.classList.add('show');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('show');
            document.body.classList.remove('modal-open');
            detailActiveIndex = null;
        }

        function saveDetailModal() {
            if (detailActiveIndex === null) return;
            const index = detailActiveIndex;

            itinerary[currentDay][index].title = document.getElementById('detail-title').innerText;
            itinerary[currentDay][index].desc = document.getElementById('detail-desc').innerHTML;

            saveItinerary();
            renderDay(currentDay);
            closeDetailModal();
        }

        function handleDetailImageUpload(input) {
            const file = input.files[0];
            if (!file || detailActiveIndex === null) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxDim = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // Update state and UI
                    itinerary[currentDay][detailActiveIndex].img = dataUrl;
                    document.getElementById('detail-img').src = dataUrl;
                    document.getElementById('detail-img-container').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Image Upload Logic (Compress & Convert to Base64)
        function handleImageUpload(input, index) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    // Compress Image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimension limits (e.g., 800px)
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 800;

                    if (width > height) {
                        if (width > maxDim) {
                            height *= maxDim / width;
                            width = maxDim;
                        }
                    } else {
                        if (height > maxDim) {
                            width *= maxDim / height;
                            height = maxDim;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Get Base64 string (JPEG 0.7 quality)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // Update Input
                    const textInput = document.getElementById(`img-${index}`);
                    textInput.value = dataUrl;

                    // Optional: Show preview immediately? 
                    // Need to save first for it to appear in UI usually, 
                    // but we can give visual feedback on the input border or something.
                    textInput.style.borderColor = '#22c55e'; // Green border
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Global state for dragging to prevent memory leaks and duplicate listeners
        let isGlobalListenersAttached = false;
        let draggingItem = null;
        let activeTouchId = null;
        let longPressTimer = null;
        let startPos = { x: 0, y: 0 };
        let dragOccurred = false;
        let currentDragCard = null;

        // Drag & Drop Logic (Optimized 800ms Long-press)
        function setupDragHandlers() {
            const container = document.getElementById('day-container');
            const cards = container.querySelectorAll('.activity-card');

            cards.forEach(card => {
                const handleStart = (e) => {
                    if (draggingItem || card.classList.contains('editing')) return;

                    const touch = e.type === 'touchstart' ? e.changedTouches[0] : e;
                    if (e.type === 'touchstart') activeTouchId = touch.identifier;
                    startPos = { x: touch.clientX, y: touch.clientY };
                    dragOccurred = false;
                    currentDragCard = card;

                    card.classList.add('pressing');

                    longPressTimer = setTimeout(() => {
                        if (window.getSelection) window.getSelection().removeAllRanges();

                        draggingItem = card;
                        dragOccurred = true;
                        card.classList.remove('pressing');
                        card.classList.add('dragging');
                        if (window.navigator.vibrate) window.navigator.vibrate(50);
                    }, 800);
                };

                const handleMove = (e) => {
                    const touch = e.type === 'touchmove' ?
                        Array.from(e.touches).find(t => t.identifier === activeTouchId) : e;
                    if (!touch) return;

                    if (!draggingItem && longPressTimer) {
                        const dist = Math.hypot(touch.clientX - startPos.x, touch.clientY - startPos.y);
                        if (dist > 15) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                            card.classList.remove('pressing');
                        }
                        return;
                    }

                    if (draggingItem) {
                        if (e.cancelable) e.preventDefault();
                        const clientY = touch.clientY;
                        const siblings = [...container.querySelectorAll('.activity-card:not(.dragging)')];

                        // Flexible detection: find the closest sibling rather than just 50/50 split
                        let nextSibling = null;
                        let minDistance = Infinity;

                        for (const sibling of siblings) {
                            const box = sibling.getBoundingClientRect();
                            const mid = box.top + box.height / 2;
                            const distance = Math.abs(clientY - mid);

                            // If we're closer to a sibling's top or bottom, we insert there
                            if (clientY < mid) {
                                nextSibling = sibling;
                                break;
                            }
                        }

                        if (nextSibling !== draggingItem.nextElementSibling) {
                            container.insertBefore(draggingItem, nextSibling);
                        }
                    }
                };

                const handleEnd = (e) => {
                    card.classList.remove('pressing');
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }

                    if (!draggingItem) {
                        activeTouchId = null;
                        return;
                    }

                    if (dragOccurred) {
                        if (e.cancelable) e.preventDefault();
                        e.stopPropagation();
                    }

                    if (e.type === 'touchend' || e.type === 'touchcancel') {
                        activeTouchId = null;
                    }

                    draggingItem.classList.remove('dragging');
                    draggingItem = null;
                    updateOrderFromDOM();
                    setTimeout(() => { dragOccurred = false; }, 100);
                };

                // Click Guard
                const clickableArea = card.querySelector('.cursor-pointer');
                if (clickableArea) {
                    const originalOnClick = clickableArea.onclick;
                    clickableArea.onclick = function (e) {
                        if (dragOccurred) {
                            return false;
                        }
                        if (originalOnClick) originalOnClick.apply(this, arguments);
                    };
                }

                card.addEventListener('touchstart', handleStart, { passive: true });
                card.addEventListener('touchmove', handleMove, { passive: false });
                card.addEventListener('touchend', handleEnd, { passive: false });
                card.addEventListener('touchcancel', handleEnd, { passive: true });
                card.addEventListener('mousedown', handleStart);
            });

            // Clean up global listeners to prevent duplicates
            if (!isGlobalListenersAttached) {
                document.addEventListener('mousemove', (e) => {
                    if (draggingItem && activeTouchId === null) {
                        const siblings = [...container.querySelectorAll('.activity-card:not(.dragging)')];
                        let nextSibling = siblings.find(sibling => {
                            const box = sibling.getBoundingClientRect();
                            return e.clientY <= box.top + box.height / 2;
                        });
                        container.insertBefore(draggingItem, nextSibling);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (draggingItem && activeTouchId === null) {
                        draggingItem.classList.remove('dragging');
                        draggingItem = null;
                        updateOrderFromDOM();
                        setTimeout(() => { dragOccurred = false; }, 100);
                    }
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                isGlobalListenersAttached = true;
            }
        }

        function updateOrderFromDOM() {
            const container = document.getElementById('day-container');
            const newCards = container.querySelectorAll('.activity-card');
            if (newCards.length === 0 && itinerary[currentDay] && itinerary[currentDay].length > 0) return;

            // Reconstruct array based on old IDs
            const newItineraryDay = [];
            let orderChanged = false;

            newCards.forEach((card, newIndex) => {
                const parts = card.id.split('-');
                if (parts.length < 2) return;
                const oldIndex = parseInt(parts[1]);
                if (isNaN(oldIndex) || !itinerary[currentDay][oldIndex]) return;

                if (oldIndex !== newIndex) orderChanged = true;
                newItineraryDay.push({ ...itinerary[currentDay][oldIndex] }); // Use copy to prevent reference issues
            });

            // ONLY update if something actually moved to prevent "åŸåœ°æ‹–ç§»" bugs
            if (orderChanged && newItineraryDay.length === itinerary[currentDay].length) {
                itinerary[currentDay] = newItineraryDay;
                saveItinerary();
                renderDay(currentDay);
            } else {
                // If nothing changed, still re-render to clean up classes but don't save or flash
                renderDay(currentDay);
            }
        }

        function showModal(msg, callback, isDanger = false) {
            const modal = document.getElementById('custom-modal');
            const msgEl = document.getElementById('modal-msg');
            const btn = document.getElementById('modal-confirm-btn');
            const icon = modal.querySelector('.w-12');

            // Clear any active interactions on cards
            document.querySelectorAll('.activity-card').forEach(c => {
                c.classList.remove('pressing', 'dragging');
            });
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            msgEl.innerText = msg;
            pendingCallback = callback;

            if (isDanger) {
                btn.className = "flex-1 px-4 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-lg shadow-red-500/30 transition-all text-sm";
                icon.className = "w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold";
                icon.innerText = "!";
            } else {
                btn.className = "flex-1 px-4 py-3 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-all text-sm";
                icon.className = "w-12 h-12 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold";
                icon.innerText = "?";
            }

            document.body.classList.add('modal-open');
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.remove('show');
            document.body.classList.remove('modal-open');
            // Fail-safe to ensure all cards are reset
            document.querySelectorAll('.activity-card').forEach(c => {
                c.classList.remove('pressing', 'dragging');
            });
            setTimeout(() => { pendingCallback = null; }, 300);
        }

        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (pendingCallback) pendingCallback();
            closeModal();
        });

        function resetData() {
            showModal('ç¢ºå®šè¦ç§»é™¤æ‰€æœ‰è‡ªè¨‚ä¿®æ”¹ï¼Œå›å¾©åˆ°åŸå§‹è¡Œç¨‹å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚', () => {
                localStorage.removeItem('trip_data_2601');
                location.reload();
            }, true);
        }

        // Action Functions
        function updateCard(index, field, value) {
            itinerary[currentDay][index][field] = value;
            saveItinerary();
        }

        function deleteCard(index, event) {
            event.stopPropagation();
            showModal('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å¡ç‰‡å—ï¼Ÿ', () => {
                itinerary[currentDay].splice(index, 1);
                saveItinerary();
                renderDay(currentDay);
            }, true);
        }

        function addNewCard() {
            itinerary[currentDay].push({
                cat: 'æ™¯é»',
                icon: 'âœ¨',
                title: 'æ–°è¡Œç¨‹',
                time: '',
                desc: 'é»æ“Šç·¨è¼¯å…§å®¹',
                map: ''
            });
            saveItinerary();
            renderDay(currentDay);
        }

        function switchDay(day) {
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-day="${day}"]`).classList.add('active');
            renderDay(day);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function changeTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            if (tab === 'packing') renderPacking();

            // Toggle FAB visibility
            const fab = document.getElementById('fab-add');
            if (tab === 'itinerary') {
                fab.classList.remove('fab-hidden');
            } else {
                fab.classList.add('fab-hidden');
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Packing Logic
        function renderPacking() {
            const container = document.getElementById('packing');
            container.innerHTML = `
                <div class="px-6 pt-6">
                    <h2 class="text-2xl font-black mb-6">ğŸ’ è¡Œææ¸…å–®</h2>
                </div>
                <div class="px-6 pb-20 space-y-6">
                    ${packing.map((cat, catIdx) => `
                        <div class="packing-category">
                            <div class="px-5 py-3 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">${cat.icon}</span>
                                    <span class="font-black text-sm uppercase tracking-wider text-slate-600">${cat.cat}</span>
                                </div>
                                <button onclick="addPackingItem(${catIdx})" class="text-xs font-black text-blue-500 hover:text-blue-600 transition-colors uppercaseTracking leading-none">+ æ–°å¢é …ç›®</button>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${cat.items.map((item, itemIdx) => `
                                    <div class="packing-item p-4 flex items-center justify-between group ${item.checked ? 'checked' : ''}">
                                        <label class="flex items-center gap-3 flex-1 cursor-pointer">
                                            <input type="checkbox" ${item.checked ? 'checked' : ''} 
                                                   onchange="togglePackingItem(${catIdx}, ${itemIdx})"
                                                   class="w-5 h-5 rounded-lg border-slate-200 text-blue-500 focus:ring-blue-500 transition-all">
                                            <span contenteditable="true" 
                                                  onblur="updatePackingItem(${catIdx}, ${itemIdx}, this.innerText)"
                                                  class="text-sm font-bold text-slate-700 outline-none">${esc(item.text)}</span>
                                        </label>
                                        <button onclick="deletePackingItem(${catIdx}, ${itemIdx})" 
                                                class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all ml-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function togglePackingItem(catIdx, itemIdx) {
            packing[catIdx].items[itemIdx].checked = !packing[catIdx].items[itemIdx].checked;
            if (window.navigator.vibrate) window.navigator.vibrate(20);
            saveItinerary();
            renderPacking();
        }

        function updatePackingItem(catIdx, itemIdx, newVal) {
            if (packing[catIdx].items[itemIdx].text === newVal) return;
            packing[catIdx].items[itemIdx].text = newVal;
            saveItinerary();
        }

        function addPackingItem(catIdx) {
            packing[catIdx].items.push({ text: "æ–°é …ç›®", checked: false });
            saveItinerary();
            renderPacking();
        }

        function deletePackingItem(catIdx, itemIdx) {
            packing[catIdx].items.splice(itemIdx, 1);
            saveItinerary();
            renderPacking();
        }

        // Init Checkboxes for shop/todo persistence (Simple version)
        document.querySelectorAll('input[type="checkbox"]').forEach((checkbox, i) => {
            const id = `check_${i}`;
            const label = checkbox.closest('label');
            const span = label.querySelector('span');

            // Load state
            if (localStorage.getItem(id) === 'true') {
                checkbox.checked = true;
                label.classList.add('strikethrough');
            }
            if (span && localStorage.getItem(id + '_text')) {
                span.innerText = localStorage.getItem(id + '_text');
            }
            if (span) {
                span.contentEditable = true;
                span.addEventListener('blur', () => {
                    localStorage.setItem(id + '_text', span.innerText);
                });
            }

            checkbox.addEventListener('change', function () {
                localStorage.setItem(id, this.checked);
                if (this.checked) label.classList.add('strikethrough');
                else label.classList.remove('strikethrough');
                updateShopProgress();
            });
        });

        function updateShopProgress() {
            const total = document.querySelectorAll('.shop-item').length;
            const checked = document.querySelectorAll('.shop-item:checked').length;
            const progress = document.getElementById('shopProgress');
            if (progress) progress.innerText = `${checked}/${total}`;
        }

        updateShopProgress();
        itinerary[1] = defaultItinerary[1]; // Force sync Day 1 data for this update
        renderDay(currentDay);
    </script>